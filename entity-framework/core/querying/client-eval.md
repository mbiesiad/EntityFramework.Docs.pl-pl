---
title: Ocena klienta a serwer — EF Core
author: smitpatel
ms.date: 10/03/2019
ms.assetid: 8b6697cc-7067-4dc2-8007-85d80503d123
uid: core/querying/client-eval
ms.openlocfilehash: e01bd146c4dfe7a8d36b641cb52ae366fddd8239
ms.sourcegitcommit: cc0ff36e46e9ed3527638f7208000e8521faef2e
ms.translationtype: MT
ms.contentlocale: pl-PL
ms.lasthandoff: 03/06/2020
ms.locfileid: "78417761"
---
# <a name="client-vs-server-evaluation"></a><span data-ttu-id="b390a-102">Klient a wersja ewaluacyjna serwera</span><span class="sxs-lookup"><span data-stu-id="b390a-102">Client vs. Server Evaluation</span></span>

<span data-ttu-id="b390a-103">Zgodnie z ogólną zasadą Entity Framework Core próbuje w miarę możliwości oszacować zapytanie na serwerze.</span><span class="sxs-lookup"><span data-stu-id="b390a-103">As a general rule, Entity Framework Core attempts to evaluate a query on the server as much as possible.</span></span> <span data-ttu-id="b390a-104">EF Core konwertuje części zapytania na parametry, które mogą być oceniane po stronie klienta.</span><span class="sxs-lookup"><span data-stu-id="b390a-104">EF Core converts parts of the query into parameters, which it can evaluate on the client side.</span></span> <span data-ttu-id="b390a-105">Pozostała część zapytania (wraz z wygenerowanymi parametrami) jest podawana dostawcy bazy danych w celu ustalenia równoważnej kwerendy bazy danych, która ma zostać obliczona na serwerze.</span><span class="sxs-lookup"><span data-stu-id="b390a-105">The rest of the query (along with the generated parameters) is given to the database provider to determine the equivalent database query to evaluate on the server.</span></span> <span data-ttu-id="b390a-106">EF Core obsługuje częściową ocenę klienta w projekcji najwyższego poziomu (zasadniczo jest to ostatnie wywołanie do `Select()`).</span><span class="sxs-lookup"><span data-stu-id="b390a-106">EF Core supports partial client evaluation in the top-level projection (essentially, the last call to `Select()`).</span></span> <span data-ttu-id="b390a-107">Jeśli projekcja najwyższego poziomu w zapytaniu nie może zostać przetłumaczona na serwer, EF Core pobierze wymagane dane z serwera i Oceń pozostałe części zapytania na kliencie.</span><span class="sxs-lookup"><span data-stu-id="b390a-107">If the top-level projection in the query can't be translated to the server, EF Core will fetch any required data from the server and evaluate remaining parts of the query on the client.</span></span> <span data-ttu-id="b390a-108">Jeśli EF Core wykryje wyrażenie w innym miejscu niż projekcja najwyższego poziomu, którego nie można przetłumaczyć na serwer, wówczas zgłasza wyjątek czasu wykonania.</span><span class="sxs-lookup"><span data-stu-id="b390a-108">If EF Core detects an expression, in any place other than the top-level projection, which can't be translated to the server, then it throws a runtime exception.</span></span> <span data-ttu-id="b390a-109">Zobacz, [jak działa zapytanie](xref:core/querying/how-query-works) , aby zrozumieć, jak EF Core określa, czego nie można przetłumaczyć na serwer.</span><span class="sxs-lookup"><span data-stu-id="b390a-109">See [how query works](xref:core/querying/how-query-works) to understand how EF Core determines what can't be translated to server.</span></span>

> [!NOTE]
> <span data-ttu-id="b390a-110">Przed wersjami 3,0 Entity Framework Core obsługiwaną ocenę klienta w dowolnym miejscu zapytania.</span><span class="sxs-lookup"><span data-stu-id="b390a-110">Prior to version 3.0, Entity Framework Core supported client evaluation anywhere in the query.</span></span> <span data-ttu-id="b390a-111">Aby uzyskać więcej informacji, zobacz [sekcję poprzednie wersje](#previous-versions).</span><span class="sxs-lookup"><span data-stu-id="b390a-111">For more information, see the [previous versions section](#previous-versions).</span></span>

> [!TIP]
> <span data-ttu-id="b390a-112">[Przykład](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) tego artykułu można wyświetlić w witrynie GitHub.</span><span class="sxs-lookup"><span data-stu-id="b390a-112">You can view this article's [sample](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Querying) on GitHub.</span></span>

## <a name="client-evaluation-in-the-top-level-projection"></a><span data-ttu-id="b390a-113">Ocena klienta w projekcji najwyższego poziomu</span><span class="sxs-lookup"><span data-stu-id="b390a-113">Client evaluation in the top-level projection</span></span>

<span data-ttu-id="b390a-114">W poniższym przykładzie metoda pomocnika służy do standaryzacji adresów URL blogów, które są zwracane z bazy danych SQL Server.</span><span class="sxs-lookup"><span data-stu-id="b390a-114">In the following example, a helper method is used to standardize URLs for blogs, which are returned from a SQL Server database.</span></span> <span data-ttu-id="b390a-115">Ponieważ dostawca SQL Server nie ma wglądu w sposób implementacji tej metody, nie można go przetłumaczyć na SQL.</span><span class="sxs-lookup"><span data-stu-id="b390a-115">Since the SQL Server provider has no insight into how this method is implemented, it isn't possible to translate it into SQL.</span></span> <span data-ttu-id="b390a-116">Wszystkie inne aspekty zapytania są oceniane w bazie danych, ale przekazywanie zwracanych `URL` za pomocą tej metody jest wykonywane na kliencie.</span><span class="sxs-lookup"><span data-stu-id="b390a-116">All other aspects of the query are evaluated in the database, but passing the returned `URL` through this method is done on the client.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientProjection)]

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientMethod)]

## <a name="unsupported-client-evaluation"></a><span data-ttu-id="b390a-117">Nieobsługiwana Ocena klienta</span><span class="sxs-lookup"><span data-stu-id="b390a-117">Unsupported client evaluation</span></span>

<span data-ttu-id="b390a-118">Gdy Ocena klienta jest użyteczna, może to spowodować niską wydajność.</span><span class="sxs-lookup"><span data-stu-id="b390a-118">While client evaluation is useful, it can result in poor performance sometimes.</span></span> <span data-ttu-id="b390a-119">Rozważmy następujące zapytanie, w którym metoda pomocnika jest teraz używana w filtrze WHERE.</span><span class="sxs-lookup"><span data-stu-id="b390a-119">Consider the following query, in which the helper method is now used in a where filter.</span></span> <span data-ttu-id="b390a-120">Ponieważ w bazie danych nie można zastosować filtru, wszystkie dane muszą zostać pobrane do pamięci, aby zastosować filtr na kliencie.</span><span class="sxs-lookup"><span data-stu-id="b390a-120">Because the filter can't be applied in the database, all the data needs to be pulled into memory to apply the filter on the client.</span></span> <span data-ttu-id="b390a-121">Na podstawie filtru i ilości danych na serwerze Ocena klienta może spowodować spadek wydajności.</span><span class="sxs-lookup"><span data-stu-id="b390a-121">Based on the filter and the amount of data on the server, client evaluation could result in poor performance.</span></span> <span data-ttu-id="b390a-122">Dlatego Entity Framework Core blokuje takie oceny klienta i zgłasza wyjątek czasu wykonywania.</span><span class="sxs-lookup"><span data-stu-id="b390a-122">So Entity Framework Core blocks such client evaluation and throws a runtime exception.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ClientWhere)]

## <a name="explicit-client-evaluation"></a><span data-ttu-id="b390a-123">Jawne oszacowanie klienta</span><span class="sxs-lookup"><span data-stu-id="b390a-123">Explicit client evaluation</span></span>

<span data-ttu-id="b390a-124">Może być konieczne jawne wymuszenie oceny klienta w niektórych przypadkach, takich jak następujące</span><span class="sxs-lookup"><span data-stu-id="b390a-124">You may need to force into client evaluation explicitly in certain cases like following</span></span>

- <span data-ttu-id="b390a-125">Ilość danych jest mała, co oznacza, że Ocena na kliencie nie wiąże się z ogromnymi karami za wydajność.</span><span class="sxs-lookup"><span data-stu-id="b390a-125">The amount of data is small so that evaluating on the client doesn't incur a huge performance penalty.</span></span>
- <span data-ttu-id="b390a-126">Używany operator LINQ nie ma żadnego tłumaczenia po stronie serwera.</span><span class="sxs-lookup"><span data-stu-id="b390a-126">The LINQ operator being used has no server-side translation.</span></span>

<span data-ttu-id="b390a-127">W takich przypadkach można jawnie zadecydować o ocenie klienta, wywołując metody takie jak `AsEnumerable` lub `ToList` (`AsAsyncEnumerable` lub `ToListAsync` dla Async).</span><span class="sxs-lookup"><span data-stu-id="b390a-127">In such cases, you can explicitly opt into client evaluation by calling methods like `AsEnumerable` or `ToList` (`AsAsyncEnumerable` or `ToListAsync` for async).</span></span> <span data-ttu-id="b390a-128">Za pomocą `AsEnumerable` można przesyłać strumieniowo wyniki, ale użycie `ToList` spowodowałoby buforowanie przez utworzenie listy, która również zajmuje dodatkową pamięć.</span><span class="sxs-lookup"><span data-stu-id="b390a-128">By using `AsEnumerable` you would be streaming the results, but using `ToList` would cause buffering by creating a list, which also takes additional memory.</span></span> <span data-ttu-id="b390a-129">Jeśli jednak wyliczasz wiele razy, przechowywanie wyników na liście pomoże więcej, ponieważ istnieje tylko jedno zapytanie do bazy danych.</span><span class="sxs-lookup"><span data-stu-id="b390a-129">Though if you're enumerating multiple times, then storing results in a list helps more since there's only one query to the database.</span></span> <span data-ttu-id="b390a-130">W zależności od określonego użycia należy oszacować, która metoda jest bardziej przydatna w przypadku.</span><span class="sxs-lookup"><span data-stu-id="b390a-130">Depending on the particular usage, you should evaluate which method is more useful for the case.</span></span>

[!code-csharp[Main](../../../samples/core/Querying/ClientEval/Sample.cs#ExplicitClientEval)]

## <a name="potential-memory-leak-in-client-evaluation"></a><span data-ttu-id="b390a-131">Potencjalny przeciek pamięci w ocenie klienta</span><span class="sxs-lookup"><span data-stu-id="b390a-131">Potential memory leak in client evaluation</span></span>

<span data-ttu-id="b390a-132">Ponieważ translacja zapytań i kompilacja są kosztowne, EF Core buforowania skompilowanego planu zapytania.</span><span class="sxs-lookup"><span data-stu-id="b390a-132">Since query translation and compilation are expensive, EF Core caches the compiled query plan.</span></span> <span data-ttu-id="b390a-133">Obiekt delegowany pamięci podręcznej może używać kodu klienta podczas przeprowadzania oceny klienta projekcji najwyższego poziomu.</span><span class="sxs-lookup"><span data-stu-id="b390a-133">The cached delegate may use client code while doing client evaluation of top-level projection.</span></span> <span data-ttu-id="b390a-134">EF Core generuje parametry dla części drzewa, które są oceniane przez klienta, i ponownie używa planu zapytania przez zastąpienie wartości parametrów.</span><span class="sxs-lookup"><span data-stu-id="b390a-134">EF Core generates parameters for the client-evaluated parts of the tree and reuses the query plan by replacing the parameter values.</span></span> <span data-ttu-id="b390a-135">Ale niektóre stałe w drzewie wyrażenia nie mogą być konwertowane do parametrów.</span><span class="sxs-lookup"><span data-stu-id="b390a-135">But certain constants in the expression tree can't be converted into parameters.</span></span> <span data-ttu-id="b390a-136">Jeśli delegowany pamięci podręcznej zawiera takie stałe, wówczas te obiekty nie mogą być zbierane jako elementy bezużyteczne, ponieważ nadal występują odwołania.</span><span class="sxs-lookup"><span data-stu-id="b390a-136">If the cached delegate contains such constants, then those objects can't be garbage collected since they're still being referenced.</span></span> <span data-ttu-id="b390a-137">Jeśli taki obiekt zawiera DbContext lub inne usługi, może to spowodować zwiększenie użycia pamięci przez aplikację w czasie.</span><span class="sxs-lookup"><span data-stu-id="b390a-137">If such an object contains a DbContext or other services in it, then it could cause the memory usage of the app to grow over time.</span></span> <span data-ttu-id="b390a-138">To zachowanie zwykle jest znakiem przecieku pamięci.</span><span class="sxs-lookup"><span data-stu-id="b390a-138">This behavior is generally a sign of a memory leak.</span></span> <span data-ttu-id="b390a-139">EF Core zgłasza wyjątek za każdym razem, gdy zawiera on stałe typu, którego nie można mapować przy użyciu bieżącego dostawcy bazy danych.</span><span class="sxs-lookup"><span data-stu-id="b390a-139">EF Core throws an exception whenever it comes across constants of a type that can't be mapped using current database provider.</span></span> <span data-ttu-id="b390a-140">Typowe przyczyny i ich rozwiązania są następujące:</span><span class="sxs-lookup"><span data-stu-id="b390a-140">Common causes and their solutions are as follows:</span></span>

- <span data-ttu-id="b390a-141">**Przy użyciu metody wystąpienia**: w przypadku używania metod wystąpienia w projekcji klienta drzewo wyrażenia zawiera stałą wystąpienia.</span><span class="sxs-lookup"><span data-stu-id="b390a-141">**Using an instance method**: When using instance methods in a client projection, the expression tree contains a constant of the instance.</span></span> <span data-ttu-id="b390a-142">Jeśli metoda nie używa żadnych danych z wystąpienia, należy rozważyć uczynienie metody statyczną.</span><span class="sxs-lookup"><span data-stu-id="b390a-142">If your method doesn't use any data from the instance, consider making the method static.</span></span> <span data-ttu-id="b390a-143">Jeśli potrzebujesz danych wystąpienia w treści metody, Przekaż określone dane jako argument do metody.</span><span class="sxs-lookup"><span data-stu-id="b390a-143">If you need instance data in the method body, then pass the specific data as an argument to the method.</span></span>
- <span data-ttu-id="b390a-144">**Przekazywanie stałych argumentów do metody**: ten przypadek występuje ogólnie przy użyciu `this` w argumencie metody klienta.</span><span class="sxs-lookup"><span data-stu-id="b390a-144">**Passing constant arguments to method**: This case arises generally by using `this` in an argument to client method.</span></span> <span data-ttu-id="b390a-145">Rozważ podzielenie argumentu w do wielu argumentów skalarnych, które mogą być mapowane przez dostawcę bazy danych.</span><span class="sxs-lookup"><span data-stu-id="b390a-145">Consider splitting the argument in to multiple scalar arguments, which can be mapped by the database provider.</span></span>
- <span data-ttu-id="b390a-146">**Inne stałe**: Jeśli stała jest w każdym innym przypadku, można sprawdzić, czy stała jest wymagana podczas przetwarzania.</span><span class="sxs-lookup"><span data-stu-id="b390a-146">**Other constants**: If a constant is come across in any other case, then you can evaluate whether the constant is needed in processing.</span></span> <span data-ttu-id="b390a-147">Jeśli jest to konieczne, aby stała się dostępna, lub jeśli nie możesz użyć rozwiązania z powyższych przypadków, Utwórz zmienną lokalną do przechowywania wartości i Użyj zmiennej lokalnej w zapytaniu.</span><span class="sxs-lookup"><span data-stu-id="b390a-147">If it's necessary to have the constant, or if you can't use a solution from the above cases, then create a local variable to store the value and use local variable in the query.</span></span> <span data-ttu-id="b390a-148">EF Core przekonwertuje zmienną lokalną do parametru.</span><span class="sxs-lookup"><span data-stu-id="b390a-148">EF Core will convert the local variable into a parameter.</span></span>

## <a name="previous-versions"></a><span data-ttu-id="b390a-149">Poprzednie wersje</span><span class="sxs-lookup"><span data-stu-id="b390a-149">Previous versions</span></span>

<span data-ttu-id="b390a-150">Poniższa sekcja ma zastosowanie do wersji EF Core przed 3,0.</span><span class="sxs-lookup"><span data-stu-id="b390a-150">The following section applies to EF Core versions before 3.0.</span></span>

<span data-ttu-id="b390a-151">Starsze wersje EF Core obsługują ocenę klienta w dowolnej części zapytania — a nie tylko projekcję najwyższego poziomu.</span><span class="sxs-lookup"><span data-stu-id="b390a-151">Older EF Core versions supported client evaluation in any part of the query--not just the top-level projection.</span></span> <span data-ttu-id="b390a-152">Dlatego, że zapytania podobne do jednego ogłoszono w sekcji [nieobsługiwana wersja ewaluacyjna klienta](#unsupported-client-evaluation) działały prawidłowo.</span><span class="sxs-lookup"><span data-stu-id="b390a-152">That's why queries similar to one posted under the [Unsupported client evaluation](#unsupported-client-evaluation) section worked correctly.</span></span> <span data-ttu-id="b390a-153">Ponieważ takie zachowanie może spowodować problemy z wydajnością, EF Core rejestrować ostrzeżenia oceny klienta.</span><span class="sxs-lookup"><span data-stu-id="b390a-153">Since this behavior could cause unnoticed performance issues, EF Core logged a client evaluation warning.</span></span> <span data-ttu-id="b390a-154">Aby uzyskać więcej informacji o wyświetlaniu danych wyjściowych rejestrowania, zobacz [Rejestrowanie](xref:core/miscellaneous/logging).</span><span class="sxs-lookup"><span data-stu-id="b390a-154">For more information on viewing logging output, see [Logging](xref:core/miscellaneous/logging).</span></span>

<span data-ttu-id="b390a-155">Opcjonalnie EF Core można zmienić zachowanie domyślne, aby zgłosić wyjątek lub nic nie robić podczas oceny klienta (z wyjątkiem w projekcji).</span><span class="sxs-lookup"><span data-stu-id="b390a-155">Optionally EF Core allowed you to change the default behavior to either throw an exception or do nothing when doing client evaluation (except for in the projection).</span></span> <span data-ttu-id="b390a-156">Wyjątek zgłaszający zachowanie mógłby być podobny do zachowania w 3,0.</span><span class="sxs-lookup"><span data-stu-id="b390a-156">The exception throwing behavior would make it similar to the behavior in 3.0.</span></span> <span data-ttu-id="b390a-157">Aby zmienić zachowanie, należy skonfigurować ostrzeżenia podczas konfigurowania opcji dla kontekstu — zwykle w `DbContext.OnConfiguring`lub w `Startup.cs`, jeśli używasz ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="b390a-157">To change the behavior, you need to configure warnings while setting up the options for your context - typically in `DbContext.OnConfiguring`, or in `Startup.cs` if you're using ASP.NET Core.</span></span>

```csharp
protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
{
    optionsBuilder
        .UseSqlServer(@"Server=(localdb)\mssqllocaldb;Database=EFQuerying;Trusted_Connection=True;")
        .ConfigureWarnings(warnings => warnings.Throw(RelationalEventId.QueryClientEvaluationWarning));
}
```
